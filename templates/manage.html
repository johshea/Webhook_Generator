{% extends "base.html" %}
{% set page = 'manage' %}
{% block title %}Manage | Webhook Manager{% endblock %}
{% block content %}
<div class="container-fluid">
  <h3 class="mb-4">Management</h3>
  <div class="row g-4">
    <!-- Webhook Targets -->
    <div class="col-12 col-lg-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title">Webhook Targets</h5>
          <form method="post" class="row g-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="add_target">
            <div class="col-12">
              <label class="form-label">Name</label>
              <input class="form-control" name="target_name" placeholder="e.g., PagerDuty Prod" required>
            </div>
            <div class="col-12">
              <label class="form-label">URL</label>
              <input class="form-control" name="target_url" placeholder="https://example.com/webhook" required>
            </div>
            <div class="col-12">
              <button class="btn btn-primary w-100">Add Target</button>
            </div>
          </form>
          <hr>
          <form method="post" class="mt-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="delete_target">
            <div class="input-group">
              <select name="target_id" class="form-select" required>
                <option value="" selected disabled>Select target to delete</option>
                {% for t in targets %}
                  <option value="{{ t.id }}">{{ t.name }} — {{ t.url }}</option>
                {% endfor %}
              </select>
              <button class="btn btn-outline-danger">Delete</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Functions -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title">Functions (JSON Templates + Schema)</h5>
          <form method="post" class="row g-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="add_function">
            <div class="col-12 col-lg-6">
              <label class="form-label">Name</label>
              <input class="form-control" name="func_name" placeholder="e.g., create_ticket" required>
            </div>
            <div class="col-12 col-lg-6">
              <label class="form-label">Description (optional)</label>
              <input class="form-control" name="func_desc" placeholder="What this function does">
            </div>
            <div class="col-12">
              <label class="form-label">JSON Template</label>
              <textarea class="form-control" name="func_template" id="func_add_template" rows="6" placeholder='{"key": "value"}' required></textarea>
              <div id="func_add_status" class="form-text"></div>
            </div>
            <div class="col-12">
              <label class="form-label">JSON Schema (optional)</label>
              <textarea class="form-control" name="func_schema" id="func_add_schema" rows="6" placeholder='{"type":"object","properties":{"key":{"type":"string"}},"required":["key"]}'></textarea>
              <div id="func_add_schema_status" class="form-text"></div>
              <div class="form-text">Schema validates payloads when this function is selected on the Send page.</div>
            </div>
            <div class="col-12">
              <button id="func_add_submit" class="btn btn-primary w-100">Add Function</button>
            </div>
          </form>
          <hr>
          <form method="post" class="mt-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="delete_function">
            <div class="input-group">
              <select name="func_id" class="form-select" required>
                <option value="" selected disabled>Select function to delete</option>
                {% for f in functions %}
                  <option value="{{ f.id }}">{{ f.name }}{% if f.description %} — {{ f.description }}{% endif %}</option>
                {% endfor %}
              </select>
              <button class="btn btn-outline-danger">Delete</button>
            </div>
          </form>

          <hr>
          <h6 class="mt-2">Edit Function</h6>
          <form method="post" action="{{ url_for('update_function') }}" class="row g-2" id="edit-function-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="col-12">
              <label class="form-label">Select Function to Edit</label>
              <select name="func_id" id="func_edit_id" class="form-select" required>
                <option value="" selected disabled>Choose...</option>
                {% for f in functions %}
                  <option value="{{ f.id }}"
                          data-name="{{ f.name }}"
                          data-desc="{{ f.description or '' }}"
                          data-template='{{ f.json_template | tojson }}'
                          data-schema='{{ f.schema_json | tojson }}'>
                    {{ f.name }}{% if f.description %} — {{ f.description }}{% endif %}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-lg-6">
              <label class="form-label">Name</label>
              <input class="form-control" name="func_name" id="func_edit_name" required>
            </div>
            <div class="col-12 col-lg-6">
              <label class="form-label">Description (optional)</label>
              <input class="form-control" name="func_desc" id="func_edit_desc">
            </div>
            <div class="col-12">
              <label class="form-label">JSON Template</label>
              <textarea class="form-control" name="func_template" id="func_edit_template" rows="6" required></textarea>
              <div id="func_edit_status" class="form-text"></div>
            </div>
            <div class="col-12">
              <label class="form-label">JSON Schema (optional)</label>
              <textarea class="form-control" name="func_schema" id="func_edit_schema" rows="6"></textarea>
              <div id="func_edit_schema_status" class="form-text"></div>
            </div>
            <div class="col-12">
              <button id="func_edit_submit" class="btn btn-secondary w-100">Save Changes</button>
            </div>
          </form>

          <hr>
          <h6 class="mt-2">Duplicate Function</h6>
          <form method="post" action="{{ url_for('duplicate_function') }}" class="row g-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="col-12">
              <label class="form-label">Function to Duplicate</label>
              <select name="func_id" class="form-select" required>
                <option value="" selected disabled>Choose...</option>
                {% for f in functions %}
                  <option value="{{ f.id }}">{{ f.name }}{% if f.description %} — {{ f.description }}{% endif %}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">New Name (optional)</label>
              <input class="form-control" name="new_name" placeholder="Leave blank to auto-generate">
            </div>
            <div class="col-12">
              <button class="btn btn-outline-primary w-100">Duplicate</button>
            </div>
          </form>

        </div>
      </div>
    </div>

    <!-- Header Sets -->
    <div class="col-12 col-lg-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title">Header Sets</h5>
          <form method="post" class="row g-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="add_headerset">
            <div class="col-12">
              <label class="form-label">Name</label>
              <input class="form-control" name="hs_name" placeholder="e.g., PagerDuty API" required>
            </div>
            <div class="col-12">
              <label class="form-label">Description (optional)</label>
              <input class="form-control" name="hs_desc" placeholder="What these headers are for">
            </div>
            <div class="col-12">
              <label class="form-label">Headers JSON</label>
              <textarea class="form-control" name="hs_json" id="hs_add_json" rows="6" placeholder='{"Authorization":"Token ...","Content-Type":"application/json"}' required></textarea>
              <div id="hs_add_status" class="form-text"></div>
            </div>
            <div class="col-12">
              <button id="hs_add_submit" class="btn btn-primary w-100">Add Header Set</button>
            </div>
          </form>
          <hr>
          <form method="post" class="mt-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="delete_headerset">
            <div class="input-group">
              <select name="hs_id" class="form-select" required>
                <option value="" selected disabled>Select header set to delete</option>
                {% for h in headersets %}
                  <option value="{{ h.id }}">{{ h.name }}{% if h.description %} — {{ h.description }}{% endif %}</option>
                {% endfor %}
              </select>
              <button class="btn btn-outline-danger">Delete</button>
            </div>
          </form>
          <div class="form-text mt-2">Header values are stored in the DB and used at send time. They’re not shown here to reduce exposure.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Users & Logs -->
  <div class="row g-4 mt-2">
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title">Users & Roles</h5>
          <form method="post" class="row g-2 mb-3">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="add_user">
            <div class="col-12 col-lg-4">
              <label class="form-label">Username</label>
              <input class="form-control" name="new_username" required>
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" name="new_password" required>
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label">Role</label>
              <select class="form-select" name="new_role">
                <option value="sender" selected>sender</option>
                <option value="viewer">viewer</option>
                <option value="admin">admin</option>
              </select>
            </div>
            <div class="col-12">
              <button class="btn btn-primary w-100">Add User</button>
            </div>
          </form>

          <form method="post" class="row g-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="delete_user">
            <div class="col-8">
              <select name="user_id" class="form-select" required>
                <option value="" selected disabled>Select user to delete</option>
                {% for u in users %}
                  <option value="{{ u.id }}">{{ u.username }} — role: {{ u.role }}{% if u.is_admin_effective %} (admin){% endif %}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-4 d-grid">
              <button class="btn btn-outline-danger">Delete</button>
            </div>
          </form>

          <form method="post" class="row g-2 mt-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="set_role">
            <div class="col-5">
              <select name="user_id" class="form-select" required>
                <option value="" selected disabled>Select user</option>
                {% for u in users %}
                  <option value="{{ u.id }}">{{ u.username }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-5">
              <select name="role_value" class="form-select" required>
                <option value="viewer">viewer</option>
                <option value="sender" selected>sender</option>
                <option value="admin">admin</option>
              </select>
            </div>
            <div class="col-2 d-grid">
              <button class="btn btn-outline-secondary">Set Role</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Recent Audit Logs</h5>
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('export_logs_csv') }}">Export CSV</a>
          </div>
          <div class="table-responsive mt-3">
            <table class="table table-sm table-striped align-middle mb-0">
              <thead>
                <tr>
                  <th scope="col">Time (UTC)</th>
                  <th scope="col">User</th>
                  <th scope="col">Action</th>
                  <th scope="col">Details</th>
                  <th scope="col">IP</th>
                </tr>
              </thead>
              <tbody>
                {% for log in logs %}
                <tr>
                  <td><code>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</code></td>
                  <td>{{ log.username or '—' }}</td>
                  <td><span class="badge text-bg-secondary">{{ log.action }}</span></td>
                  <td style="max-width: 600px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    {{ log.details }}
                  </td>
                  <td>{{ log.ip or '—' }}</td>
                </tr>
                {% else %}
                <tr><td colspan="5" class="text-muted">No logs yet.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Populate edit form when selecting a function
document.addEventListener("DOMContentLoaded", function () {
  const sel = document.getElementById("func_edit_id");
  const nameI = document.getElementById("func_edit_name");
  const descI = document.getElementById("func_edit_desc");
  const tmplI = document.getElementById("func_edit_template");
  const schemaI = document.getElementById("func_edit_schema");

  if (sel) {
    sel.addEventListener("change", function () {
      const opt = this.selectedOptions[0];
      if (!opt) return;
      nameI.value = opt.dataset.name || "";
      descI.value = opt.dataset.desc || "";
      try {
        const raw = JSON.parse(opt.dataset.template || ""{}"");
        try { const parsed = JSON.parse(raw); tmplI.value = JSON.stringify(parsed, null, 2); } catch { tmplI.value = raw; }
      } catch { tmplI.value = "{}"; }
      try {
        const sraw = JSON.parse(opt.dataset.schema || "null");
        if (sraw) { schemaI.value = JSON.stringify(sraw, null, 2); } else { schemaI.value = ""; }
      } catch { schemaI.value = ""; }
      tmplI.dispatchEvent(new Event("input"));
      schemaI.dispatchEvent(new Event("input"));
    });
  }
});

// Live JSON validators
(function () {
  function isValidJSON(str) { try { JSON.parse(str); return true; } catch (e) { return false; } }
  function wireChecker(textareaId, statusId, submitId, allowEmpty) {
    const ta = document.getElementById(textareaId);
    const status = document.getElementById(statusId);
    const submit = document.getElementById(submitId);
    if (!ta || !status || !submit) return;
    function update() {
      const val = ta.value.trim();
      if (!val) {
        status.textContent = allowEmpty ? "Optional field" : "Enter JSON...";
        status.className = "form-text text-muted";
        submit.disabled = !allowEmpty;
        return;
      }
      if (isValidJSON(val)) {
        status.textContent = "Valid JSON ✔";
        status.className = "form-text text-success";
        submit.disabled = false;
      } else {
        status.textContent = "Invalid JSON ✖";
        status.className = "form-text text-danger";
        submit.disabled = true;
      }
    }
    ta.addEventListener("blur", function () {
      if (isValidJSON(ta.value)) ta.value = JSON.stringify(JSON.parse(ta.value), null, 2);
    });
    ta.addEventListener("input", update);
    update();
  }
  document.addEventListener("DOMContentLoaded", function () {
    wireChecker("func_add_template", "func_add_status", "func_add_submit", false);
    wireChecker("func_add_schema", "func_add_schema_status", "func_add_submit", true);
    wireChecker("func_edit_template", "func_edit_status", "func_edit_submit", false);
    wireChecker("func_edit_schema", "func_edit_schema_status", "func_edit_submit", true);
    wireChecker("hs_add_json", "hs_add_status", "hs_add_submit", false);
  });
})();
</script>
{% endblock %}