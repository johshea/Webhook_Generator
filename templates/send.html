{% extends "base.html" %}
{% set page = 'send_webhook' %}
{% block title %}Send Webhook | Webhook Manager{% endblock %}
{% block content %}
<div class="container-fluid">
  <h3 class="mb-3">Webhook Generator</h3>
  <form method="post" id="send-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="function_id" id="hidden_function_id">
    <div class="row g-3">
      <div class="col-12 col-lg-4">
        <label class="form-label">Target</label>
        <select class="form-select" name="target_id" required>
          <option value="" selected disabled>Select a target</option>
          {% for t in targets %}
            <option value="{{ t.id }}">{{ t.name }} — {{ t.url }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-lg-4">
        <label class="form-label">Function (optional)</label>
        <select class="form-select" id="function_id">
          <option value="">(none)</option>
          {% for f in functions %}
            <option value="{{ f.id }}">{{ f.name }}{% if f.description %} — {{ f.description }}{% endif %}</option>
          {% endfor %}
        </select>
        <div class="form-text">Selecting a function will pre-fill the payload. If the function has a JSON Schema, the payload will be validated server-side before sending.</div>
      </div>
      <div class="col-12 col-lg-4">
        <label class="form-label">Header Set (optional)</label>
        <select class="form-select" name="headerset_id">
          <option value="">(none)</option>
          {% for h in headersets %}
            <option value="{{ h.id }}">{{ h.name }}{% if h.description %} — {{ h.description }}{% endif %}</option>
          {% endfor %}
        </select>
        <div class="form-text">Header values are managed by admins and are not shown here.</div>
      </div>
      <div class="col-12">
        <label class="form-label">JSON Payload</label>
        <textarea class="form-control" name="payload" id="payload" rows="12" placeholder='{"example":"value"}' required></textarea>
      </div>
      <div class="col-12">
        <button class="btn btn-primary">Send Webhook</button>
      </div>
    </div>
  </form>

  {% if status is not none %}
  <hr class="my-4">
  <div class="row g-3">
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-2">HTTP Status</h5>
          <p class="mb-0"><code>{{ status }}</code></p>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-2">Payload Sent</h5>
          <pre class="mb-0" style="white-space: pre-wrap;">{{ sent_payload }}</pre>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-2">Response (truncated)</h5>
          <pre class="mb-0" style="white-space: pre-wrap;">{{ response_text }}</pre>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const funcSelect = document.getElementById("function_id");
  const payloadBox = document.getElementById("payload");
  const hiddenFunc = document.getElementById("hidden_function_id");

  funcSelect.addEventListener("change", async function () {
    const fid = this.value;
    hiddenFunc.value = fid || "";
    if (!fid) return;
    try {
      const resp = await fetch(`{{ url_for('send_webhook') }}?function_id=${fid}`, {
        headers: {"X-Requested-With": "XMLHttpRequest"}
      });
      const data = await resp.json();
      if (data.template) {
        try { payloadBox.value = JSON.stringify(JSON.parse(data.template), null, 2); }
        catch { payloadBox.value = data.template; }
      }
    } catch (e) {
      console.error(e);
    }
  });
});
</script>
{% endblock %}